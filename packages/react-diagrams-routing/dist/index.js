!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["projectstorm/react-diagrams-routing"]=e():t["projectstorm/react-diagrams-routing"]=e()}(window,function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=12)}([function(t,e){t.exports=require("@projectstorm/react-diagrams-defaults")},function(t,e){t.exports=require("react")},function(t,e){t.exports=require("lodash")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(1),s=i(4),r=i(5),o=i(2),a=i(14),h=i(0),g=i(15);class l extends h.DefaultLinkFactory{constructor(){super(l.NAME),this.ROUTING_SCALING_FACTOR=5,this.canvasMatrix=[],this.routingMatrix=[],this.hAdjustmentFactor=0,this.vAdjustmentFactor=0,this.calculateMatrixDimensions=()=>{const t=o.values(this.engine.getModel().getNodes()).map(t=>({x:t.getX(),width:t.width,y:t.getY(),height:t.height})),e=o.values(this.engine.getModel().getLinks()),i=o.flatMap(e.map(t=>[t.getSourcePort(),t.getTargetPort()])).filter(t=>null!==t).map(t=>({x:t.getX(),width:t.width,y:t.getY(),height:t.height})),n=o.flatMap(e.map(t=>t.getPoints())).map(t=>({x:t.getX(),width:0,y:t.getY(),height:0})),s=(t,e)=>o.reduce(e,(e,i)=>e+o.get(t,i,0),0),r=this.engine.getCanvas(),a=o.concat(t,i,n),h=Math.floor(Math.min(o.get(o.minBy(a,"x"),"x",0),0)/this.ROUTING_SCALING_FACTOR)*this.ROUTING_SCALING_FACTOR,g=o.maxBy(a,t=>s(t,["x","width"])),l=Math.max(s(g,["x","width"]),r.offsetWidth),c=o.minBy(a,"y"),d=Math.floor(Math.min(o.get(c,"y",0),0)/this.ROUTING_SCALING_FACTOR)*this.ROUTING_SCALING_FACTOR,u=o.maxBy(a,t=>s(t,["y","height"])),p=Math.max(s(u,["y","height"]),r.offsetHeight);return{width:Math.ceil(Math.abs(h)+l),hAdjustmentFactor:Math.abs(h)/this.ROUTING_SCALING_FACTOR+1,height:Math.ceil(Math.abs(d)+p),vAdjustmentFactor:Math.abs(d)/this.ROUTING_SCALING_FACTOR+1}},this.markNodes=t=>{o.values(this.engine.getModel().getNodes()).forEach(e=>{const i=Math.floor(e.getX()/this.ROUTING_SCALING_FACTOR),n=Math.ceil((e.getX()+e.width)/this.ROUTING_SCALING_FACTOR),s=Math.floor(e.getY()/this.ROUTING_SCALING_FACTOR),r=Math.ceil((e.getY()+e.height)/this.ROUTING_SCALING_FACTOR);for(let e=i-1;e<=n+1;e++)for(let i=s-1;i<r+1;i++)this.markMatrixPoint(t,this.translateRoutingX(e),this.translateRoutingY(i))})},this.markPorts=t=>{o.flatMap(o.values(this.engine.getModel().getLinks()).map(t=>[].concat(t.getSourcePort(),t.getTargetPort()))).filter(t=>null!==t).forEach(e=>{const i=Math.floor(e.x/this.ROUTING_SCALING_FACTOR),n=Math.ceil((e.x+e.width)/this.ROUTING_SCALING_FACTOR),s=Math.floor(e.y/this.ROUTING_SCALING_FACTOR),r=Math.ceil((e.y+e.height)/this.ROUTING_SCALING_FACTOR);for(let e=i-1;e<=n+1;e++)for(let i=s-1;i<r+1;i++)this.markMatrixPoint(t,this.translateRoutingX(e),this.translateRoutingY(i))})},this.markMatrixPoint=(t,e,i)=>{void 0!==t[i]&&void 0!==t[i][e]&&(t[i][e]=1)}}setDiagramEngine(t){super.setDiagramEngine(t),t.getStateMachine().registerListener({stateChanged:e=>{if(e.newState instanceof g.AbstractDisplacementState){const e=t.getActionEventBus().registerAction(new g.Action({type:g.InputType.MOUSE_UP,fire:()=>{this.calculateRoutingMatrix(),t.repaintCanvas(),e()}}))}}}),this.listener=t.registerListener({canvasReady:()=>{o.defer(()=>{this.calculateRoutingMatrix(),t.repaintCanvas()})}})}setFactoryBank(t){super.setFactoryBank(t),!t&&this.listener&&this.listener.deregister()}generateReactWidget(t){return n.createElement(r.PathFindingLinkWidget,{diagramEngine:this.engine,link:t.model,factory:this})}generateModel(t){return new s.PathFindingLinkModel}getCanvasMatrix(){return 0===this.canvasMatrix.length&&this.calculateCanvasMatrix(),this.canvasMatrix}calculateCanvasMatrix(){const{width:t,hAdjustmentFactor:e,height:i,vAdjustmentFactor:n}=this.calculateMatrixDimensions();this.hAdjustmentFactor=e,this.vAdjustmentFactor=n;const s=Math.ceil(t/this.ROUTING_SCALING_FACTOR),r=Math.ceil(i/this.ROUTING_SCALING_FACTOR);this.canvasMatrix=o.range(0,r).map(()=>new Array(s).fill(0))}getRoutingMatrix(){return 0===this.routingMatrix.length&&this.calculateRoutingMatrix(),this.routingMatrix}calculateRoutingMatrix(){const t=o.cloneDeep(this.getCanvasMatrix());this.markNodes(t),this.markPorts(t),this.routingMatrix=t}translateRoutingX(t,e=!1){return t+this.hAdjustmentFactor*(e?-1:1)}translateRoutingY(t,e=!1){return t+this.vAdjustmentFactor*(e?-1:1)}generateDynamicPath(t){let e=a();return e=e.moveto(t[0][0]*this.ROUTING_SCALING_FACTOR,t[0][1]*this.ROUTING_SCALING_FACTOR),t.slice(1).forEach(t=>{e=e.lineto(t[0]*this.ROUTING_SCALING_FACTOR,t[1]*this.ROUTING_SCALING_FACTOR)}),e.print()}}l.NAME="pathfinding",e.PathFindingLinkFactory=l},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(3),s=i(0);e.PathFindingLinkModel=class extends s.DefaultLinkModel{constructor(t={}){super(Object.assign({type:n.PathFindingLinkFactory.NAME},t))}performanceTune(){return!1}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(1),s=i(2),r=i(6),o=i(0);e.PathFindingLinkWidget=class extends n.Component{constructor(t){super(t),this.refPaths=[],this.state={selected:!1},this.pathFinding=new r.default(this.props.factory)}componentDidUpdate(){this.props.link.setRenderedPaths(this.refPaths.map(t=>t.current))}componentDidMount(){this.props.link.setRenderedPaths(this.refPaths.map(t=>t.current))}componentWillUnmount(){this.props.link.setRenderedPaths([])}generateLink(t,e){const i=n.createRef();return this.refPaths.push(i),n.createElement(o.DefaultLinkSegmentWidget,{key:`link-${e}`,path:t,selected:this.state.selected,diagramEngine:this.props.diagramEngine,factory:this.props.diagramEngine.getFactoryForLink(this.props.link),link:this.props.link,forwardRef:i,onSelection:t=>{this.setState({selected:t})},extras:{}})}render(){this.refPaths=[];var t=this.props.link.getPoints(),e=[];const i=this.pathFinding.calculateDirectPath(s.first(t),s.last(t)),r=this.props.factory.getRoutingMatrix(),o=this.pathFinding.calculateLinkStartEndCoords(r,i);if(o){const{start:t,end:i,pathToStart:n,pathToEnd:s}=o,a=this.pathFinding.calculateDynamicPath(r,t,i,n,s);e.push(this.generateLink(this.props.factory.generateDynamicPath(a),"0"))}return n.createElement(n.Fragment,null,e)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(13),s=new n.JumpPointFinder({heuristic:n.Heuristic.manhattan,diagonalMovement:n.DiagonalMovement.Never});e.default=class{constructor(t){this.instance=s,this.factory=t}calculateDirectPath(t,e){const i=this.factory.getCanvasMatrix(),r=new n.Grid(i);return s.findPath(this.factory.translateRoutingX(Math.floor(t.getX()/this.factory.ROUTING_SCALING_FACTOR)),this.factory.translateRoutingY(Math.floor(t.getY()/this.factory.ROUTING_SCALING_FACTOR)),this.factory.translateRoutingX(Math.floor(e.getX()/this.factory.ROUTING_SCALING_FACTOR)),this.factory.translateRoutingY(Math.floor(e.getY()/this.factory.ROUTING_SCALING_FACTOR)),r)}calculateLinkStartEndCoords(t,e){const i=e.findIndex(e=>!!t[e[1]]&&0===t[e[1]][e[0]]),n=e.length-1-e.slice().reverse().findIndex(e=>!!t[e[1]]&&0===t[e[1]][e[0]]);if(-1===i||-1===n)return;const s=e.slice(0,i),r=e.slice(n);return{start:{x:e[i][0],y:e[i][1]},end:{x:e[n][0],y:e[n][1]},pathToStart:s,pathToEnd:r}}calculateDynamicPath(t,e,i,r,o){const a=new n.Grid(t),h=s.findPath(e.x,e.y,i.x,i.y,a),g=r.concat(h,o).map(t=>[this.factory.translateRoutingX(t[0],!0),this.factory.translateRoutingY(t[1],!0)]);return n.Util.compressPath(g)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(1),s=i(8),r=i(0),o=i(9);class a extends n.Component{constructor(t){super(t),this.handleMove=function(t){this.draggingEvent(t,this.dragging_index)}.bind(this),this.handleUp=function(t){this.setState({canDrag:!1,selected:!1}),window.removeEventListener("mousemove",this.handleMove),window.removeEventListener("mouseup",this.handleUp)}.bind(this),this.refPaths=[],this.state={selected:!1,canDrag:!1},this.dragging_index=0}componentDidUpdate(){this.props.link.setRenderedPaths(this.refPaths.map(t=>t.current))}componentDidMount(){this.props.link.setRenderedPaths(this.refPaths.map(t=>t.current))}componentWillUnmount(){this.props.link.setRenderedPaths([])}generateLink(t,e,i){const s=n.createRef();return this.refPaths.push(s),n.createElement(r.DefaultLinkSegmentWidget,{key:`link-${i}`,path:t,selected:this.state.selected,diagramEngine:this.props.diagramEngine,factory:this.props.diagramEngine.getFactoryForLink(this.props.link),link:this.props.link,forwardRef:s,onSelection:t=>{this.setState({selected:t})},extras:e})}calculatePositions(t,e,i,n){if(0===i){let e=new s.PointModel({link:this.props.link,position:new o.Point(t[i].getX(),t[i].getY())});return this.props.link.addPoint(e,i),void this.dragging_index++}if(i===t.length-2){let e=new s.PointModel({link:this.props.link,position:new o.Point(t[i+1].getX(),t[i+1].getY())});return void this.props.link.addPoint(e,i+1)}if(i-2>0){let s={[i-2]:t[i-2].getPosition(),[i+1]:t[i+1].getPosition(),[i-1]:t[i-1].getPosition()};if(Math.abs(s[i-1][n]-s[i+1][n])<5)return s[i-2][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],s[i+1][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],t[i-2].setPosition(s[i-2]),t[i+1].setPosition(s[i+1]),t[i-1].remove(),t[i-1].remove(),this.dragging_index--,void this.dragging_index--}if(i+2<t.length-2){let s={[i+3]:t[i+3].getPosition(),[i+2]:t[i+2].getPosition(),[i+1]:t[i+1].getPosition(),[i]:t[i].getPosition()};if(Math.abs(s[i+1][n]-s[i+2][n])<5)return s[i][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],s[i+3][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],t[i].setPosition(s[i]),t[i+3].setPosition(s[i+3]),t[i+1].remove(),void t[i+1].remove()}let r={[i]:t[i].getPosition(),[i+1]:t[i+1].getPosition()};r[i][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],r[i+1][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],t[i].setPosition(r[i]),t[i+1].setPosition(r[i+1])}draggingEvent(t,e){let i=this.props.link.getPoints(),n=Math.abs(i[e].getX()-i[e+1].getX()),s=Math.abs(i[e].getY()-i[e+1].getY());0===n?this.calculatePositions(i,t,e,"x"):0===s&&this.calculatePositions(i,t,e,"y"),this.props.link.setFirstAndLastPathsDirection()}render(){let t=this.props.link.getPoints(),e=[],i=t[0],r=t[t.length-1],a=!1;i.getX()>r.getX()&&(i=t[t.length-1],r=t[0],a=!0);let h=Math.abs(t[0].getY()-t[t.length-1].getY());if(null===this.props.link.getTargetPort()&&2===t.length)[...Array(2)].forEach(t=>{this.props.link.addPoint(new s.PointModel({link:this.props.link,position:new o.Point(i.getX(),r.getY())}),1)}),this.props.link.setManuallyFirstAndLastPathsDirection(!0,!0);else if(null===this.props.link.getTargetPort()&&null!==this.props.link.getSourcePort())t[1].setPosition(r.getX()+(i.getX()-r.getX())/2,a?r.getY():i.getY()),t[2].setPosition(r.getX()+(i.getX()-r.getX())/2,a?i.getY():r.getY());else if(!this.state.canDrag&&t.length>2)for(let e=1;e<t.length;e+=t.length-2)e-1==0?this.props.link.getFirstPathXdirection()?t[e].setPosition(t[e].getX(),t[e-1].getY()):t[e].setPosition(t[e-1].getX(),t[e].getY()):this.props.link.getLastPathXdirection()?t[e-1].setPosition(t[e-1].getX(),t[e].getY()):t[e-1].setPosition(t[e].getX(),t[e-1].getY());2!==t.length||0===h||this.state.canDrag||this.props.link.addPoint(new s.PointModel({link:this.props.link,position:new o.Point(i.getX(),r.getY())}));for(let i=0;i<t.length-1;i++)e.push(this.generateLink(s.LinkWidget.generateLinePath(t[i],t[i+1]),{"data-linkid":this.props.link.getID(),"data-point":i,onMouseDown:t=>{0===t.button&&(this.setState({canDrag:!0}),this.dragging_index=i,window.addEventListener("mousemove",this.handleMove),window.addEventListener("mouseup",this.handleUp))},onMouseEnter:t=>{this.setState({selected:!0}),this.props.link.lastHoverIndexOfPath=i}},i));return this.refPaths=[],n.createElement("g",{"data-default-link-test":this.props.link.getOptions().testName},e)}}a.defaultProps={color:"red",width:3,link:null,smooth:!1,diagramEngine:null,factory:null},e.RightAngleLinkWidget=a},function(t,e){t.exports=require("@projectstorm/react-diagrams-core")},function(t,e){t.exports=require("@projectstorm/geometry")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(1),s=i(7),r=i(0),o=i(11);class a extends r.DefaultLinkFactory{constructor(){super(a.NAME)}generateModel(t){return new o.RightAngleLinkModel}generateReactWidget(t){return n.createElement(s.RightAngleLinkWidget,{diagramEngine:this.engine,link:t.model,factory:this})}}a.NAME="rightAngle",e.RightAngleLinkFactory=a},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(0),s=i(10);e.RightAngleLinkModel=class extends n.DefaultLinkModel{constructor(t={}){super(Object.assign({type:s.RightAngleLinkFactory.NAME},t)),this.lastHoverIndexOfPath=0,this._lastPathXdirection=!1,this._firstPathXdirection=!1}setFirstAndLastPathsDirection(){let t=this.getPoints();for(let e=1;e<t.length;e+=t.length-2){let i=Math.abs(t[e].getX()-t[e-1].getX()),n=Math.abs(t[e].getY()-t[e-1].getY());e-1==0?this._firstPathXdirection=i>n:this._lastPathXdirection=i>n}}addPoint(t,e=1){return super.addPoint(t,e),this.setFirstAndLastPathsDirection(),t}deserialize(t){super.deserialize(t),this.setFirstAndLastPathsDirection()}setManuallyFirstAndLastPathsDirection(t,e){this._firstPathXdirection=t,this._lastPathXdirection=e}getLastPathXdirection(){return this._lastPathXdirection}getFirstPathXdirection(){return this._firstPathXdirection}setWidth(t){this.options.width=t,this.fireEvent({width:t},"widthChanged")}setColor(t){this.options.color=t,this.fireEvent({color:t},"colorChanged")}}},function(t,e,i){"use strict";function n(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}Object.defineProperty(e,"__esModule",{value:!0}),n(i(3)),n(i(4)),n(i(5)),n(i(7)),n(i(10)),n(i(11)),n(i(6)),n(i(16))},function(t,e){t.exports=require("pathfinding")},function(t,e){t.exports=require("paths-js/path")},function(t,e){t.exports=require("@projectstorm/react-canvas-core")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(8),s=i(17),r=i(2),o=i(9);e.DagreEngine=class{constructor(t={}){this.options=t}redistribute(t){var e=new s.graphlib.Graph({multigraph:!0});e.setGraph(this.options.graph||{}),e.setDefaultEdgeLabel(function(){return{}});const i={};r.forEach(t.getNodes(),t=>{e.setNode(t.getID(),{width:t.width,height:t.height})}),r.forEach(t.getLinks(),t=>{t.getSourcePort()&&t.getTargetPort()&&(i[t.getID()]=!0,e.setEdge({v:t.getSourcePort().getNode().getID(),w:t.getTargetPort().getNode().getID(),name:t.getID()}))}),s.layout(e),e.nodes().forEach(i=>{const n=e.node(i);t.getNode(i).setPosition(n.x-n.width/2,n.y-n.height/2)}),this.options.includeLinks&&e.edges().forEach(i=>{const s=e.edge(i),r=t.getLink(i.name),a=[r.getFirstPoint()];for(let t=1;t<s.points.length-2;t++)a.push(new n.PointModel({link:r,position:new o.Point(s.points[t].x,s.points[t].y)}));r.setPoints(a.concat(r.getLastPoint()))})}}},function(t,e){t.exports=require("dagre")}])});